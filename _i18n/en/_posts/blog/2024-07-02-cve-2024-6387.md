---
layout: post
title:  "Sovereign Cloud Stack Security Note regreSSHion (CVE-2024-6387)"
category: security
author:
- "Kurt Garloff"
avatar:
- "garloff.jpg"
about:
- "garloff"
---

## The vulnerability

When connections are made to the openssh-server process (sshd),
it waits for successful authentication. After a while (120s is
the default in recent versions), the process terminates waiting.
This is implemented by sending a signal (SIGALARM). Unfortunately
the signal handler uses library functions (such as `syslog()`) that
are not safe to be used in signal handlers. This allows attackers
to mount brute force attacks to get sshd to execute arbitrary code
with root privileges.
Despite the address space layout randomization (ASLR) protections,
it has been shown that these can be overcome within ~ half a dozen
of hours at least on 32bit systems using glibc. It is believed that
64bit systems can be attacked as well, though the additional
bits available for ASLR make the current attack mechanisms require
roughly a week of trying. Additional optimizations may make this
attack more practical even on 64bit systems with ASLR. 

The result of a successful remote attack is
a root shell on the affected system (escalation of privileges).

This issue was reported by Qualys and has been assigned
[CVE-2024-6387](https://www.cve.org/CVERecord?id=CVE-2024-6387).
It is referred to as "regreSSHion" in the press, as the problem
had been solved already in the distant past (and is thus a regression)
and affects SSH.
It affects very old openssh versions as well as the current
8.5p1-9.7p1 (incl).

The [original report](https://blog.qualys.com/vulnerabilities-threat-research/2024/07/01/regresshion-remote-unauthenticated-code-execution-vulnerability-in-openssh-server)
from Qualys is worth reading for those interested in details.

## Impact on the SCS reference implementation

The hosts in the [Sovereign Cloud Stack](https://scs.community/)
reference implementation typically have sshd running for
remote management (via ansible). These are in a protected
network not reachable by normal users, though.
Admin laptops or VMs however may not be protected as well.

Users of SCS Cloud and Container platforms will have VMs running
with sshd accessible -- it is the standard way to access Linux VMs.
Most of these will be vulnerable.

## Mitigation and Fixes

The openssh team has published a new version 9.8 which has fixes for this
issue included. There are also minimal patches that can be used by Linux
distributors to fix older versions.

At this point in time, updated packages have been provided by Debian and
Ubuntu; RedHat and SUSE are expected to follow soon.
Users are advised to perform online updates and restart sshd for their VMs
as soon as online updates are available.

SCS providers provide upstream images as a courtesy to their users; they
are advised to update the public images as soon as new ones are available.
The [SCS image standard](https://docs.scs.community/standards/scs-0102-v1-image-metadata#image-build-info)
mandates metadata that indicates an `image_build_date` metadata field that
users can use to determine until what point in time patches are included.
Providers promising their users updates via the `hotfix_hours` are required
to replace the images within the given time (after the fixed upstream images
have been provided).

In absence of patched versions, users can lower the `MaxStartups` to e.g.
`10:40:40` to increase the time until being hacked and adjust the value
of `LoginGraceTime` a bit (from the default of `120`) to thwart optimization
attempts of the attackers. Setting the latter value to `0` avoids the
vulnerable code path but makes sshd vulnerable to DoS attacks and is
thus only a last resort. Custom firewall rules may be more helpful for
protecting VMs.

## Version history

* Initial Draft, v0.1, 2024-07-02, 09:45 CET.
