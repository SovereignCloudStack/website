---
layout: post
title:  "Rookify: Migrating from Ceph-Ansible to Rook"
category: tech
author:
- "Rafael te Boekhorst"
avatar:
- "rboekhorst.jpg"
about:
- "rboekhorst.jpg"
---

## Migrating from Ceph-Ansible to Rook with Rookify

To facilitate the transition from Ceph-Ansible to Rook, SCS has almost finished developing a migration tool called [Rookify](https://github.com/SovereignCloudStack/rookify). This tool simplifies and streamlines the migration process, making it easier for users to switch from a Ceph-Ansible deployment to Rook. The tool is now under first technical preview and is being tested.

Rookify is a python package that uses a **state-machine** based on the [transitions-library]() to migrate the various mons, mgrs, osds, mds and anything else one might have setup for ceph to rook. For each of these resources, rookify offers a module which can be run separatly, yet each module can also imply other modules as its necessary parents: the `mgirate-mons`-module needs e.g. the `analyze-ceph` module first, because rookify needs to find out where which mons are located and whereto they should be migrated.
For this uses a simple `config.yml` to point to the various configuration-dependencies (like sshkeys, k8s and ceph configs) and allows to neatly decide which modules should be run. 

Rookify optionally (recommended) allows to use a **pickle-file** to save the state of progress externally in a file (basically serialized python objects). There are allready features in development, that update the currently somehwat simple cli-interface to also read from this file and to use the modules to return the exact state of the migration. This also means, that rookify can continue a discontinued or partially failed migration.

## Test run

If you would like to try out and test the current state of rookify, you can use the testbed of OSISM. 

### Testbed setup

_NOTE_: the Testbed of OSISM is for the use of testing. This means that it is inherently unstable. If ceph and k3s cannot be deployed without failure, you will have to wait for a fix of the testbed or find another way to test rookify.

First you need to setup ceph:

```bash
git clone github.com:osism/testbed.git
make ceph # this will pull needed roles, prepare venv environment, build infrastructure, create the manager and then deploy ceph
````

Then deploy k3s with the rook-oeprator:

```bash
# within the testbed repository use makefile to login to manager
make login 
osism apply k3s
osism apply rook-operator
```

If you now would want to adapt some of rooks configuration, then see `/opt/configuration/environments/rook/` and checkout OSISM's documentation on rook [here]() for the various settings.

## Rookify Setup and Configuration to use for the Testbed of OSISM

**First**: clone the rookify directory, then setup rookify and build the python package for venv:

```bash
git clone https://github.com/SovereignCloudStack/rookify
cd rookify
make setup # This downloads the needed venv libraries and then installs the rookify package into .venv/bin/rookify of the working directory
```

_NOTE_: some error concerning the absence of the `python-rados`-libary. You can run `check-radoslib` to ensure that the library is installed locally on you pc, if not then install the package manually. The python-rados libary should have version 2.0.0 as of the writing of this blog (check the README.md file of rookify for more up-to-date documentation). The library could not be integrated within the setup, because there are currently no builds for pip.

**Second**: copy `config.example.osism.yml` to `config.yml` and adapt the various configuration settings as needed. Rookify will need access to an ssh-key (e.g. the `.id.rsa` file in the `terraform` directory in the testbed repository), ceph configuration files (see e.g. `/etc/ceph/` on one of the nodes) and k8s files (e.g. `~/.kube/config` from the manager node). Check if the makefile contains any helper-functions to asist you: simply run `make` in the root of the working directory to see all options that the makefile offers. 

_Very important_: make sure rookify can connect to the testbed. In order to do this we will use one of the testbeds built-in vpns:


**third**: run rookify to test it. Rookify allows the usage of `--dry-run` which runs modules in test mode. Note that rookify always runs the various modules in test mode first and only then continues to use the truly. In any case it is safe to run the `example` modules or the `analyze-ceph` module. In the following we will try to run `analyze-ceph` and try to save its collected state in a pickle-file. Make sure you something like the following `config.yml`, especially note the sections denoting configuration files for ceph, ssh and k8s, then make sure that you set the module to execute in the section `migration_modules`:

```
# you can use sshuttle
make vpn-sshuttle
# or you can use wireguard
make vpn-wireguard # requires you to run make vpn-wireguard-config first
``

Now try to run the `analyze-ceph` module by makeing sure that the `config.yml` looks something like this...

```yaml
general:
  machine_pickle_file: data.pickle

logging:
  level: INFO # level at which logging should start
  format:
    time: "%Y-%m-%d %H:%M.%S" # other example: "iso"
    renderer: console # or: json

ceph:
  config: ./.ceph/ceph.conf
  keyring: ./.ceph/ceph.client.admin.keyring

# fill in correct path to private key
ssh:
  private_key: /home/USER/.ssh/cloud.private
  hosts:
    testbed-node-0:
      address: 192.168.16.10
      user: dragon
    testbed-node-1:
      address: 192.168.16.11
      user: dragon
    testbed-node-2:
      address: 192.168.16.12
      user: dragon

kubernetes:
  config: ./k8s/config

rook:
  cluster:
    name: osism-ceph
    namespace: rook-ceph
    mds_placement_label: node-role.osism.tech/rook-mds
    mgr_placement_label: node-role.osism.tech/rook-mgr
    mon_placement_label: node-role.osism.tech/rook-mon
    osd_placement_label: node-role.osism.tech/rook-osd
    rgw_placement_label: node-role.osism.tech/rook-rgw
  ceph:
    image: quay.io/ceph/ceph:v18.2.1

migration_modules: # this sets the modules that need to be run. Note that some of the modules require other modules to be run as well, this will happen automatically.
- analyze_ceph
```

If all is good you can give it a go by running this command:

```bash
.venv/bin/rookify --dry-run
# or simply
.venv/bin/rookify # the analyze_ceph module is not expected to break anything
```

If all is setup correctly you might see an output similar to this:

```bash

```




