---
layout: post
title:  "Rookify: Migration von Ceph-Ansible zu Rook"
category: tech
author:
- "Rafael te Boekhorst"
avatar:
- "rboekhorst.jpg"
about:
- "rboekhorst.jpg"
---

## Migration von Ceph-Ansible zu Rook mit Rookify

Um den Übergang von Ceph-Ansible zu Rook zu erleichtern, hat SCS ein Migrationswerkzeug namens [Rookify](https://github.com/SovereignCloudStack/rookify) fast fertig entwickelt. Dieses Tool vereinfacht und optimiert den Migrationsprozess, sodass Benutzer problemlos von einer Ceph-Ansible-Installation zu Rook wechseln können. Das Tool befindet sich derzeit in einem ersten technischen Preview und wird getestet.

### Funktionen und Design

#### Statemachine (Zustandsautomat)

Rookify ist ein Python-Paket, das einen Zustandsautomaten-Ansatz verwendet, basierend auf der ['transitions-library'](https://github.com/pytransitions/transitions), um verschiedene Ressourcen wie Monitore, Manager, OSDs, MDS und andere zu Rook zu migrieren. Jede dieser Ressourcen hat ein entsprechendes [Modul](https://github.com/SovereignCloudStack/rookify/tree/main/src/rookify/modules) in Rookify, das unabhängig oder in Kombination mit anderen Modulen ausgeführt werden kann.

Es ist wichtig zu beachten, dass die meisten Module Abhängigkeiten zu anderen Modulen haben und diese bei Bedarf implizit ausführen. Zum Beispiel muss das migrate-mons-Modul zuerst das analyze-ceph-Modul ausführen (wie durch die [REQUIRES-Variable](https://github.com/SovereignCloudStack/rookify/blob/main/src/rookify/modules/migrate_monitors/main.py) angegeben). Dies ist notwendig, damit Rookify den aktuellen Standort der Monitore bestimmen und festlegen kann, wohin sie migriert werden sollen.

Rookify kann durch Bearbeiten einer umfassenden `config.yml`-Datei konfiguriert werden, wie zum Beispiel in der bereitgestellten [config.example.yaml](https://github.com/SovereignCloudStack/rookify/blob/main/config.example.yaml). Diese Konfigurationsdatei spezifiziert verschiedene Abhängigkeiten (wie SSH-Schlüssel, Kubernetes- und Ceph-Konfigurationen) und ermöglicht es Benutzern, einfach zu entscheiden, welche Module ausgeführt werden sollen (siehe den Abschnitt `migration_modules` unten im `config.yaml`).

#### Eine einfache CLI mit Pickle-Unterstützung

Rookify unterstützt optional (empfohlen) die Verwendung einer **Pickle-Datei** (siehe oben im Abschnitt `general` in `config.example.yaml`). Pickle ist ein Modul zur Objektserialisierung, das den Fortschrittsstatus extern speichert, d.h. welche Module ausgeführt wurden und Informationen über die Zielmaschine. Derzeit sind neue Funktionen in Entwicklung, um die bestehende CLI-Oberfläche zu verbessern, sodass sie die Pickle-Datei lesen und die Module von Rookify verwenden kann, um den genauen Stand des Migrationsprozesses zu berichten. Dies bedeutet, dass Rookify genau dort fortfahren kann, wo eine unterbrochene oder teilweise fehlgeschlagene Migration aufgehört hat.

Derzeit bietet Rookify nur eine einfache CLI-Oberfläche:

```
usage: Rookify [-h] [--dry-run]

options:
  -h, --help  show this help message and exit
  --dry-run
```

#### Rookifys Arbeitsablauf: Wie wird die Aufgabe erledigt?

Die Hauptfunktion von Rookify ist es, alle Ressourcen von Ceph zu Rook zu migrieren. Schauen wir uns den Abschnitt migration_modules in der `config.yml`-Datei an:

```
migration_modules:
- migrate_mons
```

Diese Konfiguration lässt Rookify die folgenden Schritte ausführen:

1. Preflight-Modus: Das `migrate_mons`-Modul läuft zuerst im Preflight-Modus, der auch manuell mit dem Befehl `rookify --dry-run` ausgelöst werden kann. In dieser Phase, führt Rookify die Preflight-Methoden für die konfigurierten Module und ihre abhängigen Module aus. Außerdem überprüft Rookify den Ausführungsstatus aus der Pickle-Datei. Wenn die Migration bereits erfolgreich abgeschlossen wurde, endet das Modul hier.

2. Abhängigkeitsprüfung: Wenn das `migrate_mons`-Modul noch nicht ausgeführt wurde (angezeigt durch eine leere Pickle-Datei), überprüft Rookify auf Abhängigkeiten, z.B. andere Module, die zuerst ausgeführt werden müssen. Es führt diese Module zuerst im Preflight-Modus und dann in Echtzeit aus. Der Status jedes Moduls wird optional in der Pickle-Datei gespeichert.

2.1 `analyze_ceph`-Modul: Rookify erkennt, dass das `analyze_ceph`-Modul in jedem Fall zuerst ausgeführt werden muss. Das `analyze_ceph`-Modul sammelt Daten über die laufenden Ceph-Ressourcen und die Kubernetes-Umgebung mit dem dort laufendem Rook-Operator. Beachten Sie, dass, wie bei jedem anderen Modul, `analyze_ceph` zuerst im Preflight-Modus läuft, um zu überprüfen, ob der Zustand bereits in der Pickle-Datei erfasst wurde. Wenn kein Zustand gefunden wird, sammelt `analyze_ceph` die notwendigen Informationen.

2.2 Cluster-Erstellung: Nach erfolgreicher Ausführung des `analyze_ceph`-Moduls überprüft Rookify auf weitere Abhängigkeiten, wie das `create_cluster`-Modul. Dieses Modul erstellt die `clustermap.yaml` für Rook basierend auf den Informationen aus `analyze_ceph` und richtet die erforderlichen Namespaces in Kubernetes ein.

3. Migrationsausführung: Nach erfolgreicher Ausführung von `analyze_ceph` und `create_cluster` wird das `migrate_mons`-Modul ausgeführt. Rookify fährt den ersten laufenden Ceph-Monitor auf dem ersten Worker-Node herunter, indem es `sudo systemctl disable --now ceph-mon.target` verwendet, und aktiviert sofort den entsprechenden Monitor in Rook, indem es seine Metadaten in der `clustermap.yaml` auf "true" setzt.

4. Monitor-Migration: Rookify setzt diesen Prozess für jeden Monitor fort, bis alle zu Rook migriert und in Betrieb genommen wurden. Optional kann der Zustand in der Pickle-Datei gespeichert werden.

Je nachdem, welche Ressourcen Sie migrieren möchten, wird Rookify einen ähnlichen Ansatz verwenden: Es wird versuchen, die Ceph-Ressource auszuschalten, nachdem sichergestellt wurde, dass es ein Äquivalent im Rook-Cluster neu erstellen kann.

## Testlauf: Ausprobierne und beim Testen helfen

Um mit Rookify zu beginnen, stellen Sie sicher, dass Sie die [README.md](https://github.com/SovereignCloudStack/rookify/blob/main/README.md) im Repository durchlesen.

Wenn Sie den aktuellen Stand von Rookify testen möchten (sehr geschätzt - melden Sie gerne [issues](https://github.com/SovereignCloudStack/rookify/issues) bei Github), können Sie das Testbed von OSISM verwenden.

### Testbed-Einrichtung

_HINWEIS_: Das OSISM-Testbed ist für Testzwecke gedacht, was bedeutet, dass es instabil sein kann. Wenn Ceph und K3s nicht fehlerfrei bereitgestellt werden können, müssen Sie möglicherweise auf eine Fehlerbehebung warten oder eine Umgehungslösung finden, um Rookify zu testen. (Zum Beispiel bietet OSISM auch eine stabilere Testumgebung namens "[Cloud in a box](https://osism.tech/docs/guides/other-guides/cloud-in-a-box/)." Ich werde in einem zukünftigen Blogpost weitere Details dazu bereitstellen.)

Um das Testbed einzurichten, konsultieren Sie zunächst die [Testbed-Dokumentation von OSISM](https://osism.tech/docs/guides/other-guides/testbed)  um sicherzustellen, dass Sie alle Anforderungen erfüllen. Wenn alles in Ordnung ist, klonen Sie das Repository und verwenden Sie make ceph, um ein Ceph-Testbed einzurichten. Dieser Befehl zieht automatisch die notwendigen Ansible-Rollen, bereitet eine virtuelle Umgebung vor, baut die Infrastruktur mit OpenStack, erstellt einen Manager-Node und stellt Ceph auf drei Worker-Nodes bereit:

```bash
git clone github.com:osism/testbed.git
make ceph
```

Sobald die Infrastruktur für Ceph und das Testbed bereitgestellt wurde, melden Sie sich mit `make login` an und stellen Sie K3s sowie einen Rook-Operator bereit:

```bash
make login 
osism apply k3s
osism apply rook-operator
```

Wenn Sie Konfigurationen ändern möchten, z.B. eine Rook-Einstellung, gehen Sie zu `/opt/configuration/environments/rook/` und sehen Sie in der [Dokumentation zu Rook von OSISM](https://osism.tech/docs/guides/configuration-guide/rook) nach, um verschiedene Einstellungen zu finden.

## Rookify-Einrichtung/Konfiguration für das Testbed von OSISM

1. **Klonen des Rookify-Repositorys**: Start by cloning the Rookify repository, setting it up, and building the Python package in a virtual environment using the Makefile. You can simply run make without any arguments to see a list of helper functions that can assist you in setting up and configuring Rookify. The command make setup downloads the necessary virtual environment libraries and installs the Rookify package into .venv/bin/rookify within the working directory:

```bash
git clone https://github.com/SovereignCloudStack/rookify
cd rookify
make setup
```

_NOTE_: If you encounter an error about the absence of the python-rados library, you can run check-radoslib to check if the library is installed locally. If not, install the package manually. The python-rados library should be version 2.0.0 at the time of writing (check the README.md file of Rookify for the most up-to-date documentation). The library could not be integrated within the setup because Ceph currently offers no builds for pip.

2. **Configure Rookify**: Copy config.example.osism.yml to config.yml and modify the various configuration settings as needed. Rookify will require access to an SSH key (e.g., the .id_rsa file in the Terraform directory in the testbed repository), Ceph configuration files (see /etc/ceph/ on one of the worker nodes), and Kubernetes files (e.g., ~/.kube/config from the manager node). Check if the Makefile contains any helper functions to assist you: run make in the root of the working directory to see all options that the Makefile offers.

_Important_: Ensure that Rookify can connect to the testbed. To do this, use one of the testbed's built-in VPNs:

```
# you can use sshuttle
make vpn-sshuttle
# Or you can use WireGuard (requires running `make vpn-wireguard-config` first)
make vpn-wireguard
```

3. **Run Rookify**: Finally, run Rookify to test it. Rookify allows the use of `--dry-run` to run modules in preflight mode. Note that Rookify always runs the various modules in preflight mode first before actually executing them. It is safe to run the `example` or `analyze_ceph` modules, as these will not make any real changes.

```yaml
general:
  machine_pickle_file: data.pickle

logging:
  level: INFO # level at which logging should start
  format:
    time: "%Y-%m-%d %H:%M.%S" # other example: "iso"
    renderer: console # or: json

ceph:
  config: ./.ceph/ceph.conf
  keyring: ./.ceph/ceph.client.admin.keyring

# fill in correct path to private key
ssh:
  private_key: /home/USER/.ssh/cloud.private
  hosts:
    testbed-node-0:
      address: 192.168.16.10
      user: dragon
    testbed-node-1:
      address: 192.168.16.11
      user: dragon
    testbed-node-2:
      address: 192.168.16.12
      user: dragon

kubernetes:
  config: ./k8s/config

rook:
  cluster:
    name: osism-ceph
    namespace: rook-ceph
    mds_placement_label: node-role.osism.tech/rook-mds
    mgr_placement_label: node-role.osism.tech/rook-mgr
    mon_placement_label: node-role.osism.tech/rook-mon
    osd_placement_label: node-role.osism.tech/rook-osd
    rgw_placement_label: node-role.osism.tech/rook-rgw
  ceph:
    image: quay.io/ceph/ceph:v18.2.1

migration_modules: # this sets the modules that need to be run. Note that some of the modules require other modules to be run as well, this will happen automatically.
- analyze_ceph
```

If everything is set up correctly, you can run Rookify without any arguments:

```bash
.venv/bin/rookify --dry-run
# or simply
.venv/bin/rookify # the analyze_ceph module is not expected to break anything
```

If all is setup correctly you might see an output similar to this:

```bash

```




